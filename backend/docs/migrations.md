# Database Migrations with Alembic

This document describes how to use Alembic for database migrations in the Universal AI Documentation System Design Companion project.

## Overview

Alembic is used for managing database schema migrations. It allows us to:
- Track changes to the database schema over time
- Apply migrations in a controlled, versioned manner
- Roll back changes if necessary
- Generate migration scripts automatically based on SQLAlchemy model changes

## Initial Setup

The initial migration has been created and applied, establishing the baseline schema for:
- `jobs` table - For tracking documentation generation jobs
- `uploaded_files` table - For managing uploaded source files and generated documentation files

## Migration Workflow

### Creating a New Migration

When you make changes to the SQLAlchemy models, generate a new migration script:

```bash
# From the backend directory
poetry run alembic revision --autogenerate -m "description_of_changes"
```

This will:
1. Compare your current SQLAlchemy models to the database schema
2. Generate a migration script in `alembic/versions/` with the necessary changes

### Applying Migrations

To apply all pending migrations:

```bash
# From the backend directory
poetry run alembic upgrade head
```

To apply migrations up to a specific version:

```bash
# From the backend directory
poetry run alembic upgrade <revision_id>
```

### Rolling Back Migrations

To roll back the most recent migration:

```bash
# From the backend directory
poetry run alembic downgrade -1
```

To roll back to a specific version:

```bash
# From the backend directory
poetry run alembic downgrade <revision_id>
```

## Best Practices

1. Always review autogenerated migration scripts before applying them
2. Test migrations in development before applying to production
3. Include migrations in version control
4. For production deployments, use a proper PostgreSQL database instead of SQLite

## Troubleshooting

If you encounter issues with Alembic:

1. Ensure your SQLAlchemy models are properly defined
2. Check that `alembic/env.py` correctly references your models
3. Verify the database URL in `alembic.ini` or `app/config.py`
4. For a clean slate, you can delete the database and all migration scripts, then recreate them

## Migration History

- Initial schema (2025-06-04): Created `jobs` and `uploaded_files` tables
